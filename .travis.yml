language: python

sudo: false

cache: false

python:
  - "3.4"

env:
  global:
    - secure: "ZMt1jW3Hkpw4oxWqIx7u9ZcTKcNtFPgarCZVnZqBi4MREzoyJt/lmwjeHAu237XMfZqnnMKvErlo/Z78fpKHaY2a6oA98/2Q8FO7AYMEQnod2noh+EbvviyuYGmv97sZ+37U3buvRQBvTOIcLwMDvZp12KH0553vRB8B5nCkduNgAzmChWvU6z2ROf7rxLc5uK0sPuuatCZKaQbhZQWU1S2NpKIPMu1h6xgRrZNE75eEduXGaBRe0UgHnKVofUZs0S/s/t1hUHuPCw1ULl2wCSAygEl+LhVTVDO7gZ/TW0rKYejXeKxwKoFoidIFhNbYY0jEfM5qH99OSzxF3KeE6v1c/BWaR/lwI3GO/NjrPH3m4020JUghoKpZgjj4hL0jZwf9zjkJqEhOEFAyAREo/bQSJgWYK+d35cdSJJB4QeQ+SFDnC8UY4jiFD3HUMgNN+Z50dC7cADCawgDog1TQp3kP6rqIoLcfy7vBnMxBeO1gQNSIwLNEZB9Bk7TIeGpFf2f5na+LgArcjaeAuU+6R0Dsokpu9/C8Hi54vPJNd3JpfISA3wIsE0JOKT0a3PCw6cQ3eseKgkMiEeg+xCF+e+GFOvLd1mCrjPxM2vqr1oJsV5MP35+hZsaUFV4k6V8NLTeyKls2wO6+IycS0pwAwwyoDo+67FpbvVPOwk6pGqE=" # FEC_CF_USERNAME
    - secure: "hoG+3Hjq+heMQz5FuDU1aXOMtn2kMVYkF1CDxVRoVGr/lXPAaBDdFiwcetyhAjG1ThYTfAldMyCo+iZh3ABBjcMnqLwhIRYRq1Flf5Soonws3JRsMfnnVVK7+CPWZ68rBNUuMm1kDid1Bf2I4y5jpVl4RTsNkP/42prbDcCiaQuXw7LhBK8ZhnsIoby7cnSLb2Sbp7wQPJnc3fYCRdfVMD8cs1igSAfjZL1vJN3TmQsl7Zr2mY/Y2BZ6AHdCSYAQKOuDzNXriwRBL9oDg4QBqJGtbPisFdpRwDAr9yhX8/Aewy65jjANwDphA4xe0VU7LeqXTbl4GGMBGgd70oJaC0FUQP25PN0AXb6b+cp9YdaQxenF+Izq50gXhnIEz5bev6tFQVEmYOnSID8mbOIf7ZG4IETaRe8pstd02rvRSCgS6rJovnKauMo0pOTpNPk45y1mSrji6rERshlPdcTRZ7pIP11+9i/AYgt149fJd3jnHx0EXSjf2/Xh05Mm7gyUCutJW+u1DW8PwsDWSRc9j7qSeLMlyWUdp2spKjZusP0KpH9018IpZRauTUFZ2TtUDgAZz68iTy4GNlHG+qR3hQCZRahnmMu2YfLvL4o6LzjU4KAk/ucvI+ZGoqk7T8bMiqBmB+9VtFfgsdqr1E2+cT01AMpH/hnfgsl+4mgnLNQ=" # FEC_CF_PASSWORD
    - secure: "zqzCm6KLCJi2DF/jh4Ft4rqHbsZfqDnLeaU7jR3lIpqfFJ9u6i4WhHWHLcfzksa371cZsVb4VupVbvS4MUPFr95r39FZDFFfGa3qv/3jheysMJ1DMJC1VSvVUFB6JNu9ZmR/IncRDxX7zTBA04qNObWFHFGDzIoNGsACwt6sVDcaVRYUy46eRRkJkfHS48oGbgd6TGfsU7Z2zCEm4LulKclpTWW7gZFa/hg+chhKwzoOTctAExgIX3C5JKER6hc1tqgpRhzoC8KltMjJwSwqirIAkCVVhpxUHZjjJktup9oBZjDXBUZmNitmjSszbLF0+LsdiF+/QcQXsT4bhHUio5oqfzkQ5X/TaX5zCBEhzWAHT31Skllq7ljuyfzH8frL/3zGu75IlGM2C9clml13mS0t+wWMvVGe4UhwDzEgy6uOd0XnT47frBz0gHZefhcYdYgTupToWCGF7pCMDCG2q/2YZvET5qsmaekBdOnYZG7JnnAgi6k72bwOrzif6KG3AJOoC0ADF6/vyZ+T9nxzUMPkshe8u39J05jfdJ8nmgHI7jK2fcNJlYFX7DuHIevsIETyzfcXDdmro/QygqVmRt8RWo7LsSE5KUhrU00Zd3X1GZqK6dxb2x76O1JMeFH7oOdDnK/xW5JAF2CW9GGEz9z2hsdVW0LWUq6RadBe/kM=" # DJANGO_SECRET_KEY this is a random key unrelated to prod but needed for django to run build commands with production settings

before_install:
  - "pip install --upgrade pip setuptools"

before_script:
  - travis_retry pip install -U pip wheel
  - travis_retry pip install -r requirements.txt
  - travis_retry pip install coverage django_coverage_plugin

  - . $HOME/.nvm/nvm.sh
  - nvm install v5.5.0
  - nvm use v5.5.0

  - travis_retry npm install
  - npm run build

script:
  - (cd fec && coverage run ./manage.py test)
  - npm run test-single

after_success:
  - travis_retry pip install codecov
  # Collect the Python coverage as XML in advance since it needs to run inside
  # the fec dir.
  - (cd fec && coverage xml)
  # Run codecov outside fec dir to include coverage/coverage.json from JS
  # testing, and disable it from running `coverage xml` since that's already
  # done.
  - codecov -X pycov

before_deploy:
  - export PATH=$HOME:$PATH
  - travis_retry curl -L -o $HOME/cf.tgz "https://cli.run.pivotal.io/stable?release=linux64-binary&version=6.15.0"
  - tar xzvf $HOME/cf.tgz -C $HOME
  - travis_retry cf install-plugin autopilot -f -r CF-Community
  - npm run build
  - DJANGO_SETTINGS_MODULE='fec.settings.production' python fec/manage.py collectstatic --noinput
  - DJANGO_SETTINGS_MODULE='fec.settings.production' python fec/manage.py compress

deploy:
  provider: script
  skip_cleanup: true
  script: invoke deploy --branch $TRAVIS_BRANCH --yes
  on:
    all_branches: true
